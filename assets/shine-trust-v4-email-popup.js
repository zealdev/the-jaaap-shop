!function(e){"use strict";const t=setInterval((()=>{window.ST_GLOBALS&&(clearInterval(t),l().then((()=>console.info("ST Email Popup loaded"))))}));class o{constructor(t){this.editor=t,this.wrapperEl=e.createElement("div")}render(){const{id:t,emailPopupID:o,status:n,editorData:l,htmlRender:s,cssRender:i}=this.editor;this.wrapperEl.setAttribute("id","st-email-popup-wrapper");const a=e.createElement("template");return a.innerHTML=s,this.wrapperEl.appendChild(a.content),{id:t,emailPopupID:o,status:n,editorData:l,cssRender:i,wrapperEl:this.wrapperEl}}}const n={},l=async function(){if(!window.ST_PLAN||"Advanced"!==window.ST_PLAN?.name||"ACTIVE"!==window.ST_PLAN?.status)return;const e=window.ST_EMAIL_POPUPS||[];if(0===e.length)return;let t="";e.map(((e,l)=>{const{id:s,status:i,cssRender:a}=e;i&&(n[s]=new o(e).render(),t+=a)})),t&&window.ST_GLOBALS.addStyle(t),s()},s=function(){for(const t in n){const o=n[t],{editorData:l,wrapperEl:s}=o,{showOnPages:a=[],showOnlyNewUser:u}=l;e.body.insertAdjacentElement("afterbegin",s);const p=a.map((e=>e.value));(p.includes("all")||p.includes(window.ST_GLOBALS.pageType)||p.includes(window.ST_GLOBALS.pageHandle))&&(!u||u&&!1===window.ST_GLOBALS.customer)&&(i.renderOverlay(s),i.renderTranslation(l),i.renderTranslation(l,"thumbnail"),i.addPopupEvents(s,o),i.checkShowPopup(s,o))}},i={toggleOverlay:function(t="show"){const o=e.getElementById("st-email-popup-overlay");if(null!==o)switch(t){case"show":o.classList.add("show");break;case"hide":o.classList.remove("show")}},renderOverlay:function(t){if(null===e.getElementById("st-email-popup-overlay")){const o=e.createElement("DIV");o.setAttribute("id","st-email-popup-overlay"),t.appendChild(o)}},renderTranslation:function(t,o="begin"){const{emailPopupID:n}=t;let l=null,s={};switch(o){case"begin":l=e.getElementById(`st-email-popup-${n}`),s={beginHeading:null!==l&&l.querySelector(".st-email-popup-heading"),beginSubHeading:null!==l&&l.querySelector(".st-email-popup-sub-heading"),beginFooterText:null!==l&&l.querySelector(".st-email-popup-footer-text"),yourEmailPlaceholder:null!==l&&l.querySelector('input[name="email"]'),yourNamePlaceholder:null!==l&&l.querySelector('input[name="fullName"]'),beginButtonText:null!==l&&l.querySelector(".st-email-popup-action"),beginDismissText:null!==l&&l.querySelector(".st-email-popup-dismiss-text")};break;case"success":l=e.getElementById(`st-email-popup-success-${n}`),s={successHeading:null!==l&&l.querySelector(".st-email-popup-heading"),successSubHeading:null!==l&&l.querySelector(".st-email-popup-sub-heading"),beginFooterText:null!==l&&l.querySelector(".st-email-popup-footer-text"),discountCode:null!==l&&l.querySelector(".st-email-popup-coupon-code-text"),successButtonText:null!==l&&l.querySelector(".st-email-popup-action")};break;case"coupon":l=e.getElementById(`st-email-popup-coupon-${n}`),s={discountCodeText:null!==l&&l.querySelector(".st-coupon-code-text"),discountCode:null!==l&&l.querySelector(".st-email-popup-coupon-code-text")};break;case"thumbnail":l=e.getElementById(`st-email-popup-coupon-thumbnail-${n}`),s={stickyThumbnailText:null!==l&&l.querySelector(".st-sticky-thumbnail-inner")}}if(null!==l)for(const e in s)if(t.hasOwnProperty(e))if("discountCode"===e)null!==s[e]&&(s[e].innerHTML=t[e]);else{const o=window.ST_GLOBALS.translate(t[e]).trim();o&&null!==s[e]&&(-1!==e.search("Placeholder")?s[e].setAttribute("placeholder",o):s[e].innerHTML=o)}},checkShowPopup:function(e,t){const o=this,{id:n,emailPopupID:l,editorData:s}=t,{displayTime:i}=s,a=e.querySelector(`#st-email-popup-${l}`);let u=parseFloat(i);if((isNaN(i)||i<0)&&(u=0),null!==a){let e=this.getCookie(`st-email-popup-${l}`)||"";if(e=e?JSON.parse(Base64.decode(e)):{},e){const{nextTime:t=0}=e;(new Date).getTime()>=t&&setTimeout((function(){a.classList.add("show"),o.countTotalView(n),o.toggleOverlay()}),1e3*u)}else setTimeout((function(){a.classList.add("show"),o.countTotalView(n),o.toggleOverlay()}),1e3*u)}},countTotalView:function(e){fetch(window.ST_GLOBALS.apiUrl+"total-views",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:window.ST_GLOBALS.shopDomain,serviceItemID:e,serviceType:"email-popup"})}).then((e=>e.json())).then((async()=>{})).catch((e=>console.log(e)))},setPopupNextTime:function(e){const{emailPopupID:t,editorData:o}=e,{displayFrequency:n,displayFrequencyUnit:l}=o;let s=this.getCookie(`st-email-popup-${t}`)||"";s=s?JSON.parse(Base64.decode(s)):{},s.nextTime=this.getNextTime(n,l),this.setCookie(`st-email-popup-${t}`,Base64.encode(JSON.stringify(s)))},addPopupEvents:function(e,t){const o=this,{emailPopupID:n,editorData:l}=t,s=e.querySelector(`#st-email-popup-${n}`);if(null!==s){const i=e.querySelector(`#st-email-popup-coupon-thumbnail-${n}`),a=s.querySelector('input[name="email"]');if(null!==a){const e=s.querySelector(".st-email-error-message");a.addEventListener("blur",(function(t){const n=o.emailInputValidation(a,l);e.innerHTML=n.message}))}const u=s.querySelector(".st-email-popup-action");null!==u&&(u.classList.contains("st-email-popup-action-link")||u.addEventListener("click",(function(e){o.formActionBeginHandle(e,s,t),e.preventDefault()})));const p=s.querySelector('[data-close="close"]');null!==p&&p.addEventListener("click",(function(e){null!==i?(o.closePopupHandle("popup","popup-coupon-thumbnail",l),o.toggleOverlay("hide")):(o.closePopupHandle("popup",null,l),o.toggleOverlay("hide"),o.setPopupNextTime(t)),e.preventDefault()}));const c=s.querySelector(".st-email-popup-dismiss-text");null!==c&&c.addEventListener("click",(function(e){null!==i?(o.closePopupHandle("popup","popup-coupon-thumbnail",l),o.toggleOverlay("hide")):(o.closePopupHandle("popup",null,l),o.toggleOverlay("hide"),o.setPopupNextTime(t)),e.preventDefault()}))}const i=e.querySelector(`#st-email-popup-success-${n}`);if(null!==i){const e=i.querySelector(".st-email-popup-coupon-code-icon");null!==e&&e.addEventListener("click",(function(e){const t=i.querySelector(".st-email-popup-coupon-code-text");window.ST_GLOBALS.copy(e,t),e.preventDefault()}));const t=i.querySelector('.st-email-popup-action[data-close="close"]');null!==t&&t.addEventListener("click",(function(e){o.closePopupHandle("popup-success","popup-coupon",l),o.toggleOverlay("hide"),e.preventDefault()}));const n=i.querySelector('.st-email-popup-close[data-close="close"]');null!==n&&n.addEventListener("click",(function(e){o.closePopupHandle("popup-success","popup-coupon",l),o.toggleOverlay("hide"),e.preventDefault()}))}const a=e.querySelector(`#st-email-popup-coupon-${n}`);if(null!==a){const e=a.querySelector(".st-email-popup-coupon-code-icon");null!==e&&e.addEventListener("click",(function(e){const t=a.querySelector(".st-email-popup-coupon-code-text");window.ST_GLOBALS.copy(e,t),e.preventDefault()}));const t=a.querySelector('[data-close="close"]');null!==t&&t.addEventListener("click",(function(e){o.closePopupHandle("popup-coupon","",l),e.preventDefault()}))}const u=e.querySelector(`#st-email-popup-coupon-thumbnail-${n}`);if(null!==u){const e=u.querySelector('[data-close="close"]');null!==e&&e.addEventListener("click",(function(e){o.closePopupHandle("popup-coupon-thumbnail","",l),o.setPopupNextTime(t),e.preventDefault()}));const n=u.querySelector(".st-sticky-thumbnail-inner");null!==n&&n.addEventListener("click",(function(e){o.closePopupHandle("popup-coupon-thumbnail","popup",l),o.toggleOverlay(),e.preventDefault()}))}},closePopupHandle:function(t,o,n){const{emailPopupID:l}=n,s=e.getElementById(`st-email-${t}-${l}`),i=e.getElementById(`st-email-${o}-${l}`);null!==s&&s.classList.remove("show"),null!==i&&i.classList.add("show")},formActionBeginHandle:async function(e,t,o){t.classList.add("loading");const n=this,{id:l,editorData:s}=o,{emailPopupID:i}=s,a=t.querySelector('input[name="fullName"]'),u=t.querySelector('input[name="email"]'),p=t.querySelector(".st-email-error-message");p.innerHTML="";let c={status:0,message:""};if(null!==u){const e=t.querySelector(".st-email-error-message");c=n.emailInputValidation(u,s),e.innerHTML=c.message}else c={status:1,message:"Validated"};if(null===u)n.togglePopupAction(i,"begin",!1),n.renderTranslation(s,"success"),n.renderTranslation(s,"coupon"),n.togglePopupAction(i,"success",!0),t.classList.remove("loading");else if(c.status){const e={name:null!==a?String(a.value).trim():"",email:String(u.value).trim(),shop:window.ST_GLOBALS.shopDomain,emailPopupID:l};n.createCustomer(e).then((e=>{e?.status?(n.renderTranslation(s,"success"),n.renderTranslation(s,"coupon"),n.closePopupHandle("popup","popup-success",s),n.setPopupNextTime(o)):p.innerHTML="This email cannot be registered. Retry!"})).finally((()=>t.classList.remove("loading")))}else t.classList.remove("loading")},createCustomer:async function(e){return await fetch(window.ST_GLOBALS.apiUrl+"email-popup-create",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then((e=>e.json())).then((async e=>e)).catch((e=>({status:0,message:e})))},emailInputValidation:function(e,t){let o={status:!1,message:""};const{invalidEmailText:n}=t;if(null!==e){const t=String(e.value).trim();o=i.validEmail(t)?{status:!0,message:""}:{status:!1,message:window.ST_GLOBALS.translate(n)}}return o},togglePopupAction:function(t="",o="begin",n=!0){let l=null;switch(o){case"begin":l=e.getElementById(`st-email-popup-${t}`);break;case"success":l=e.getElementById(`st-email-popup-success-${t}`);break;case"coupon":l=e.getElementById(`st-email-popup-coupon-${t}`);break;case"thumbnail":l=e.getElementById(`st-email-popup-coupon-thumbnail-${t}`)}null!==l&&(n?l.classList.add("show"):l.classList.remove("show"))},validEmail:function(e){return/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(e)},getNextTime:function(e,t){let o=(new Date).getTime();switch(t){case"minute":o+=60*e*1e3;break;case"hour":o+=60*e*60*1e3;break;case"day":o+=24*e*60*60*1e3}return o},getCookie:function(e){if(void 0!==window.Cookies)return Cookies.get(e)},setCookie:function(e,t,o=!1){if(void 0===window.Cookies)return!1;Cookies.set(e,t,o)},deleteCookie:function(e){if(void 0===window.Cookies)return!1;Cookies.delete(e)}}}(window.document);